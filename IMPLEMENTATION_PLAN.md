# XS言語 実装計画

## 概要
AI向け高速静的解析言語「XS」の実装計画。S式ベースの静的型付き言語で、HM型推論を実装する。

## 言語設計の方針
- **AIのための設計**: 高速な静的解析結果を返すことを最優先
- **構造化データ処理**: AIが理解しやすい構造化データの処理を可能に
- **S式構文**: パーサー実装の効率化と解析の高速化
- **静的型付き**: 明示的な型アノテーションをサポート
- **HM型推論**: 型の自動推論による記述効率の向上
- **自己参照アドレス**: コードを内容ハッシュで管理し、差分管理を効率化
- **シェル入力対応**: 人間が使いやすいcd/lsのような入力も可能に

## 実装ステップ

### 1. プロジェクト初期設定 ✅
- [x] Rust workspaceの作成
- [x] 各crateの初期構造作成
  - parser
  - checker
  - interpreter
  - cli
- [x] 共通型定義用のcore crateの作成

### 2. Parser実装（TDD） ✅
- [x] AST定義
  - 基本的なS式表現
  - 型アノテーション構文
  - リテラル、識別子、リスト
- [x] パーサー基本実装
  - トークナイザー（lexer.rs）
  - S式パーサー
  - エラーハンドリング
- [x] テスト
  - 単純なS式のパース
  - 型アノテーション付きS式
  - let-rec構文のサポート

### 3. Type Checker実装（TDD） 🚧
- [x] 型システムの定義
  - 基本型（Int, Bool, String, List, Function）
  - 型変数
  - 型スキーム
- [x] HM型推論エンジン
  - 制約生成
  - 単一化（Unification）
  - 一般化と具体化
- [x] スコープ管理
  - 変数スコープ
  - 型スコープ
- [ ] テスト（重点的に）
  - 基本的な型推論 ✅
  - let多相 ✅
  - 関数の型推論 ✅
  - let-recの型推論 ❌ (バグあり)
  - エラーケース ✅

### 4. Interpreter実装（TDD） 🚧
- [x] 値の表現
  - ランタイム値の定義（value.rs）
  - 環境（変数束縛）
- [x] 評価器
  - S式の評価
  - 関数適用
  - 特殊形式（let, if, lambda, let-rec）
- [ ] テスト
  - 型推論を通過したプログラムの実行
  - 各種データ型の操作
  - 再帰関数

### 5. CLI実装 🚧
- [x] コマンドライン引数パーサー（clap使用）
- [x] 各サブコマンドの実装
  - `xsc parse <file>`: AST表示
  - `xsc check <file>`: 型チェック結果表示
  - `xsc run <file>`: プログラム実行
- [ ] エラー表示の整形
- [ ] REPL機能の追加

### 6. 統合テストとサンプル 🚧
- [ ] エンドツーエンドテスト
- [x] サンプルプログラム作成
  - 基本的な計算（arithmetic.xs）
  - リスト操作（list.xs）
  - 高階関数（lambda.xs）
  - 型推論の活用例（identity.xs）
  - 再帰関数（factorial.xs）

### 7. AI向け拡張機能
- [ ] 構造化データ処理機能
  - ASTの内容ハッシュ管理
  - 差分解析API
  - 構造化クエリ機能
- [ ] シェルモード実装
  - 簡易コマンド入力（cd/ls風）
  - ワンライナー実行
  - 結果の構造化出力
- [ ] 高速静的解析API
  - 型情報の即座取得
  - スコープ情報の照会
  - 依存関係グラフの生成

## 言語仕様（概要）

### 基本構文
```lisp
; 変数定義
(let x 42)
(let f (lambda (x) (+ x 1)))

; 型アノテーション
(let x : Int 42)
(let f : (-> Int Int) (lambda (x) (+ x 1)))

; 関数適用
(f 10)

; 条件分岐
(if (< x 10) "small" "large")

; リスト
(list 1 2 3)
(cons 1 (list 2 3))
```

### 型システム
- 基本型: Int, Bool, String
- 複合型: List a, (-> a b)
- 型変数: a, b, c...
- Let多相

## 技術的な実装方針
- **パーサー**: 手書きパーサー（実装済み）
- **型推論**: Algorithm W（実装済み、let-recにバグあり）
- **エラー報告**: 詳細な位置情報付き（Span型で管理）
- **最適化**: AI用途のため、静的解析の高速化を重視
- **自己参照管理**: 将来的に内容ハッシュベースのコード管理を実装
- **インクリメンタルコンパイル**: Salsaフレームワークを使用（実装済み）
- **メモリ管理**: Perceus GC方式（IR層まで実装済み）
- **コード生成**: WebAssembly GCターゲット（基本実装済み）

## 現在の進捗と今後の作業

### 完了したタスク
1. 初期設定 ✅
2. Parser実装 ✅
3. Type Checker基本実装 ✅
4. Interpreter基本実装 ✅
5. CLI基本実装 ✅

### 残りのタスク
1. Type Checkerのバグ修正（let-rec）: 1時間
2. Interpreter/CLIの完全テスト: 2時間
3. REPL機能の実装: 2時間
4. シェルモード実装: 3時間
5. 構造化データ処理機能: 4時間
6. 統合テストとドキュメント: 2時間

計: 約14時間