# XS言語ブートストラップ実装計画

## 概要

XS言語のセルフホスティング（自分自身でコンパイラを実装）を実現するための段階的な実装計画です。

## 現在の状況

### 完了済み
- ✅ 基本的なビルトイン関数の実装（stringAt, charCode, toString等）
- ✅ 標準ライブラリの基礎（State モナド、Result型、do記法）
- ✅ レキサーの部分的実装（xs/parser/lexer.xs）
- ✅ パーサーの骨組み（xs/parser/parser.xs）
- ✅ 型システムの定義（xs/checker/types.xs）

### 不足している機能
- ❌ 文字列操作関数（stringContains, stringToFloat等）
- ❌ 参照型（ref/deref）によるミュータブルな状態管理
- ❌ try-catch相当のエラーハンドリング
- ❌ マクロシステム
- ❌ ファイルI/O

## フェーズ1: 最小限のブートストラップ（3-4週間）

### 目標
Rustで実装された既存のパーサーと同等の機能をXSで実装し、簡単なXSプログラムをパースできるようにする。

### タスク
1. **必須ビルトイン関数の追加**（1週間）
   - [ ] stringContains: 文字列に部分文字列が含まれるかチェック
   - [ ] stringToFloat: 文字列を浮動小数点数に変換
   - [ ] floatToString: 浮動小数点数を文字列に変換
   - [ ] stringJoin: 文字列のリストを結合
   - [ ] stringSplit: 文字列を区切り文字で分割

2. **レキサーの完成**（1週間）
   - [ ] エスケープシーケンスの完全なサポート
   - [ ] 浮動小数点数リテラルの処理
   - [ ] コメントの適切な処理
   - [ ] エラー位置の正確な追跡

3. **パーサーの実装**（2週間）
   - [ ] S式の完全なパース
   - [ ] すべてのASTノードタイプのサポート
   - [ ] エラーメッセージの改善
   - [ ] メタデータの保持

### 検証方法
- 既存のRustパーサーの出力と比較
- tests/xs_tests/内のすべてのテストケースをパース

## フェーズ2: 型チェッカーの実装（4-6週間）

### 目標
Hindley-Milner型推論を実装し、型安全性を保証する。

### タスク
1. **型環境の実装**（1週間）
   - [ ] 型スキームの管理
   - [ ] スコープの適切な処理
   - [ ] ビルトイン関数の型定義

2. **型推論エンジン**（3週間）
   - [ ] ユニフィケーションアルゴリズム
   - [ ] Let多相の実装
   - [ ] 再帰関数の型推論
   - [ ] パターンマッチの型チェック

3. **エラー報告**（2週間）
   - [ ] 分かりやすいエラーメッセージ
   - [ ] 型の不一致の具体的な説明
   - [ ] 修正候補の提案

### 検証方法
- 既存の型チェッカーと同じ結果を出力
- 型エラーのあるプログラムを正しく検出

## フェーズ3: インタープリターの実装（3-4週間）

### 目標
XSで書かれたプログラムを直接実行できるインタープリターを実装。

### タスク
1. **評価器の実装**（2週間）
   - [ ] 環境（Environment）の管理
   - [ ] クロージャの実装
   - [ ] 再帰関数の評価
   - [ ] パターンマッチの実行

2. **ビルトイン関数の統合**（1週間）
   - [ ] FFI（Foreign Function Interface）の設計
   - [ ] Rustビルトイン関数の呼び出し

3. **最適化**（1週間）
   - [ ] 末尾再帰最適化
   - [ ] 環境の効率的な管理

### 検証方法
- 既存のインタープリターと同じ実行結果
- パフォーマンスベンチマーク

## フェーズ4: コンパイラバックエンドの実装（6-8週間）

### 目標
WebAssemblyまたは中間表現へのコンパイラを実装。

### タスク
1. **IR（中間表現）への変換**（3週間）
   - [ ] ASTからIRへの変換
   - [ ] 型付きIRの生成
   - [ ] 最適化パスの実装

2. **コード生成**（3週間）
   - [ ] WebAssembly命令への変換
   - [ ] メモリ管理（Perceus GC）
   - [ ] モジュールシステムの実装

3. **ランタイムサポート**（2週間）
   - [ ] ビルトイン関数のランタイム実装
   - [ ] エラーハンドリング
   - [ ] デバッグ情報の生成

### 検証方法
- 生成されたコードの実行テスト
- 既存のコンパイラとの出力比較

## フェーズ5: セルフホスティングの達成（2-3週間）

### 目標
XSで書かれたコンパイラが自分自身をコンパイルできるようにする。

### タスク
1. **ブートストラップスクリプト**（1週間）
   - [ ] 多段階コンパイルの自動化
   - [ ] 検証プロセスの実装

2. **最終調整**（1-2週間）
   - [ ] パフォーマンスチューニング
   - [ ] バグ修正
   - [ ] ドキュメント整備

### 検証方法
- セルフコンパイルの成功
- 生成されたコンパイラでテストスイートが通る

## 必要な追加機能

### 言語機能
1. **マクロシステム**
   - 構文拡張のサポート
   - 衛生的マクロ
   - コンパイル時計算

2. **エフェクトシステム**
   - I/O操作の型安全な表現
   - エラーハンドリングの統一

3. **モジュールシステムの拡張**
   - 循環依存の解決
   - インターフェースの定義

### ツールとインフラ
1. **ビルドシステム**
   - 依存関係管理
   - インクリメンタルコンパイル

2. **テストフレームワーク**
   - プロパティベーステスト
   - カバレッジ測定

3. **開発ツール**
   - LSP（Language Server Protocol）実装
   - REPLの改善

## リスクと課題

### 技術的課題
- **パフォーマンス**: XSで書かれたコンパイラの実行速度
- **メモリ使用量**: 大規模プロジェクトでのスケーラビリティ
- **エラー処理**: 適切なエラー回復メカニズム

### 対策
- プロファイリングツールの早期導入
- インクリメンタルな最適化
- 既存実装との継続的な比較

## タイムライン

```
Month 1-2: フェーズ1（レキサー・パーサー）
Month 2-3: フェーズ2（型チェッカー）
Month 4:   フェーズ3（インタープリター）
Month 5-6: フェーズ4（コンパイラバックエンド）
Month 7:   フェーズ5（セルフホスティング）
```

## 成功指標

1. **機能的完全性**: すべてのXS言語機能をサポート
2. **パフォーマンス**: Rust実装の2倍以内の実行時間
3. **信頼性**: 既存のテストスイートが100%パス
4. **保守性**: 明確なアーキテクチャとドキュメント

## 次のステップ

1. 不足しているビルトイン関数の実装から開始
2. レキサーのテストを充実させる
3. パーサーの段階的な実装

この計画は進捗に応じて調整されます。各フェーズの完了時に振り返りを行い、必要に応じて計画を更新します。