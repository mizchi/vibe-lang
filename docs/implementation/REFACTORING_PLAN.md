# XS Language リファクタリング計画

## コードレビュー結果

### 1. エラー処理の問題
- **問題**: エラー位置情報（Span）の取り扱いが一貫していない
  - ParseErrorで時々`span.start`を使い、時々`0`をハードコード
  - TypeErrorで`Span::new(0, 0)`をハードコード
- **影響**: デバッグとエラーメッセージの品質低下

### 2. 重複コードの問題
- **問題**: 組み込み関数の実装で大量の重複
  - interpreter/src/lib.rsの`apply_builtin`メソッド内
  - 各演算子（+, -, *, /, <, >, <=, >=, =）で同じパターンの繰り返し
  - checker/src/lib.rsでも組み込み関数の型定義が重複
- **影響**: メンテナンス性の低下、バグ修正時の漏れリスク

### 3. 型の重複
- **問題**: `Value::Closure`と`Value::RecClosure`の重複
  - 両者の違いは関数名を保持するかどうかだけ
  - 処理ロジックもほぼ同じ
- **影響**: コードの複雑性増加

### 4. テストカバレッジ
- **良好な点**: 77個のテストが存在、主要機能はカバー
- **改善点**: 
  - let-recの型推論テストが`#[ignore]`になっている（recで解決済み）
  - 統合テストが少ない

## リファクタリング優先順位

### 高優先度

1. **エラー処理の統一**
   - Span情報を持つエラー専用の構造体を作成
   - すべてのエラー生成箇所でSpan情報を適切に設定
   - エラーメッセージのフォーマットを統一

2. **組み込み関数の重複解消**
   - 二項演算子用の共通ヘルパー関数を作成
   - 演算子の定義をデータ駆動に変更
   - interpreterとcheckerで共通の組み込み関数定義を共有

### 中優先度

3. **Value型の統合**
   - `Value::Closure`に`Option<Ident>`フィールドを追加
   - `Value::RecClosure`を削除
   - 関連する処理ロジックを統一

4. **パーサーの重複コード削減**
   - let/let-rec/recの共通部分を抽出
   - パラメータパース処理の共通化
   - エラー処理パターンの統一

### 低優先度

5. **テストユーティリティの作成**
   - テスト用のASTビルダー
   - 共通のアサーション関数
   - テストケースのパラメータ化

6. **モジュール構造の改善**
   - 組み込み関数を別モジュールに分離
   - 共通の型定義をxs_coreに集約
   - より明確な責任分離

## 実装順序

1. エラー処理の統一（1-2日）
2. 組み込み関数の重複解消（1日）
3. Value型の統合（半日）
4. パーサーの重複コード削減（1日）
5. テストユーティリティ作成（半日）
6. モジュール構造の改善（1日）

## 期待される効果

- コードの可読性向上
- バグの減少
- 新機能追加時の作業量削減
- より良いエラーメッセージ
- メンテナンス性の向上