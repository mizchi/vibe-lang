# XS Language リファクタリング計画

## 現在の重複コード状況

### 1. パーサーの重複（最優先）
- **問題**: parser/src/lib.rsに149箇所の重複（98%以上の類似度）
- **影響**: 約1700行のコードで大量の重複
- **解決策**: 
  - parser_helpers.rsの更なる活用
  - 共通パターンの抽出とヘルパーメソッド化
  - parse_*メソッドの統一的なエラーハンドリング

### 2. ShellStateの重複
- **問題**: shell/src/lib.rsが721行（リファクタリング後294行、59%削減可能）
- **影響**: メンテナンス性の低下
- **解決策**: lib_refactored.rsの検証と適用

### 3. テストコードの重複（一部完了）
- **完了**: recursion_tests.rs（77%削減）、codebase_tests.rs（63%削減）、effect_system_tests.rs（34%削減）
- **残課題**: 他のテストファイルへの共通ヘルパー適用

## 未解決の技術的負債

### エラー処理の統一
- Span情報を持つエラー専用の構造体の作成
- すべてのエラー生成箇所でSpan情報を適切に設定
- エラーメッセージのフォーマットを統一

### 型の重複
- `Value::Closure`と`Value::RecClosure`の統合検討
- `TypeScheme`と`Type`の関係整理

## リファクタリング優先順位

### 高優先度
1. パーサーの重複コード削減
2. ShellStateのリファクタリング適用

### 中優先度
3. 残りのテストファイルへの共通ヘルパー適用
4. エラーハンドリングの統一
5. CIへのsimilarity-rs組み込み

### 低優先度
6. 型定義の整理と統合
7. より高度なテストパターンの導入